#!/usr/bin/env python3

import os
import typing
import subprocess
from pathlib import Path
from concurrent.futures import ProcessPoolExecutor, as_completed

import click


def to_title_case(parts):
    return "".join([part.capitalize() for part in parts])


Cmd = typing.Literal["markdown", "build", "list"]


class Album(typing.NamedTuple):
    input_path: Path
    name: str
    title: str
    out: str
    is_private: bool


def build_album(album):
    cmd = [
        "sigal",
        "build",
        "--title",
        album.title,
        str(album.input_path),
        album.out,
    ]
    result = subprocess.run(cmd, capture_output=True, text=True)
    (Path(album.out) / ".gitignore").write_text("*")
    return (album.name, result.stdout, result.stderr, result.returncode)


@click.command()
@click.argument("function", default="build", type=click.Choice(typing.get_args(Cmd)))
def main(function: Cmd) -> None:
    albums: list[Album] = []
    # List all subdirectories in ./inputs (one level deep)
    for album_path in sorted([p for p in Path("./inputs").iterdir() if p.is_dir()]):
        is_private = (album_path / ".priv").exists()
        album = album_path.name
        if is_private:
            name = " ".join(album.split("_"))
            out = os.path.join("gallery", album)
            capitalized_title = name
        else:
            name = album.replace("_", " ")[album.index("_") + 1 :]
            parts = album.split("_")[1:]
            out = os.path.join("gallery", "".join([p[0] for p in parts]))
            capitalized_title = to_title_case(parts)
        albums.append(
            Album(
                is_private=is_private,
                input_path=album_path,
                name=name,
                title=capitalized_title,
                out=out,
            )
        )

    jobs = []
    for album in albums:
        match function:
            case "markdown":
                if not album.is_private:
                    click.echo(f"- [{album.name}](./{Path(album.out).name}/)")
            case "build":
                # save to build in parallel later
                jobs.append(album)
            case "list":
                click.echo(Path(album.out).name)
            case _:
                typing.assert_never(function)

    if jobs:
        if not os.path.exists("gallery"):
            os.mkdir("gallery")
        with ProcessPoolExecutor() as executor:
            future_to_album = {
                executor.submit(build_album, album): album for album in jobs
            }
            for future in as_completed(future_to_album):
                album = future_to_album[future]
                name, stdout, stderr, returncode = future.result()
                click.echo(f"\n=== {name} ===\n")
                if stdout:
                    click.echo(stdout.strip())
                if stderr:
                    click.echo(stderr.strip(), err=True)
                if returncode != 0:
                    click.echo(
                        f"Build failed for {click.style(name, 'red')} (exit code {returncode})",
                        err=True,
                    )


if __name__ == "__main__":
    main()
